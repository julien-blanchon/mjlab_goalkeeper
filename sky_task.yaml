name: goalkeeper-task

workdir: .

num_nodes: 1
resources:
  infra: lambda
  accelerators: A100:1
  use_spot: false
  autostop:
    idle_minutes: 30
    down: true

file_mounts:
  /sky_workdir/outputs: ./outputs

envs:
  RUN_NAME: ""
  MAX_ITERATIONS: 30000

secrets:
  WANDB_API_KEY: null
  WANDB_ENTITY: null

setup: |
  curl -L https://lambdalabs-guest-agent.s3.us-west-2.amazonaws.com/scripts/install.sh | sudo bash
  sudo apt-get update && sudo apt-get install -y libegl1 libgl1 libgles2 jq uuid-runtime
  curl -LsSf https://astral.sh/uv/install.sh | sh
  uvx wandb login ${WANDB_API_KEY}
  uv sync

run: |
  set -euo pipefail
  WANDB_RUN_ID="$(uuidgen | cut -c1-8)"
  RUN_NAME="${RUN_NAME:-$WANDB_RUN_ID}"
  WANDB_RUN_PATH="$WANDB_ENTITY/mjlab-goalkeeper/runs/$WANDB_RUN_ID"

  mkdir -p /sky_workdir/outputs/$RUN_NAME

  MUJOCO_GL=egl uv run train Mjlab-Goalkeeper \
    --env.is-finite-horizon True \
    --env.scene.num-envs 4096 \
    --device cuda:0 \
    --agent.seed 42 \
    --agent.logger wandb \
    --agent.wandb-project mjlab-goalkeeper \
    --agent.max-iterations $MAX_ITERATIONS \
    2>&1 | tee /sky_workdir/outputs/$RUN_NAME/logs.txt

  timeout 10s env MUJOCO_GL=egl uv run play Mjlab-Goalkeeper-Play \
    --wandb-run-path "$WANDB_RUN_PATH" \
    --video True \
    --video-length 500 \
    --num-envs 1 \
    --viewer auto \
    --video-width 1280 \
    --video-height 720

  cp -f "./logs/rsl_rl/goalkeeper/wandb_checkpoints/${WANDB_RUN_ID}/videos/play/rl-video-step-0.mp4" /sky_workdir/outputs/$RUN_NAME/video.mp4
